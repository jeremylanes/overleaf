import G from"node:fs/promises";import N from"node:module";import D from"process";var A=(e,s)=>new Error(`invalid moduleId: "${e}" (used by ${s})`),F=(e,s)=>new Error(`un-mocked moduleId: "${e}" (used by ${s})`),T=()=>new Error("For versions of node prior to v20.6.0, the loader chain process must include esmock. start the process using --loader=esmock."),v=(e,s)=>new Error(`no mocks provided for module: "${e}" (used by ${s})`),$={errModuleIdNotFound:A,errModuleIdNotMocked:F,errMissingLoader:T,errModuleIdNoDefs:v};var[y,V]=D.versions.node.split(".").map(e=>+e),S=y<16||y===16&&V<12,u=import.meta.url,W=/\?esmkgdefs=.*/,E=/.*\?esmkgdefs=/,R=/#-#esmkdefs/,b=/^file:\/\/\/import\?/,x=/file:\/\/\/import\?([^#]*)/,z=/\bimport,|,import\b|\bimport\b/g,h=/esmkTreeId=\d*/,B=/esmkModuleId=([^&]*)/,w=/\?esmk=\d*/,k=/.*exportNames=(.*)/,H=/.*#-#/,P=/isesm=true/,q=/isfound=false/,J=/^(commonjs|module)$/,O=/strict=3/,M=/^(#![^\n]*\n)/,U=(e,s)=>new RegExp(`.*(${e}(\\?${s}(?:(?!#-#).)*)).*`),I=global.mockKeys=global.mockKeys||{},g=global.mockKeysSource=global.mockKeysSource||{},oe=!N.register&&(({port:e})=>(e.addEventListener("message",s=>s.data.keysource?g[s.data.keysource]=s.data.source:I[s.data.key]=s.data.keylong),e.unref(),"global.postMessageEsmk = d => port.postMessage(d)")),te=N.register&&(e=>{e&&e.port&&e.port.on("message",s=>{s.keysource?g[s.keysource]=s.source:I[s.key]=s.keylong})}),C=e=>{let[s,o]=e.match(x)||[];return[s,k.test(o)&&o.replace(k,"$1").split(",")]},Q=e=>{let s=e.split(R)[1]||"",o=C(s),n=e.replace(E,""),t=C(n);return[o[0]||t[0],[...new Set([o[1]||[],t[1]||[]].flat())]]},j=e=>w.test(e)&&I[e.match(w)[0].split("=")[1]],L=async(e,s,o)=>o.parentURL&&(o.conditions.slice(-1)[0]==="node-addons"||o.importAssertions||S)?e(s,o):e(s),re=async(e,s,o)=>{let{parentURL:n}=s,t=j(n)||n;if(!h.test(t))return L(o,e,s);let[l]=String(t).match(h),[c,d]=t.split(R),r=c&&c.replace(E,"");if(t.includes(`esmkModuleId=${e}&isfound=false`)){let p=U(`file:///${e}`,l),f=(r.match(p)||d.match(p)||[])[2];if(f)return{shortCircuit:!0,url:u+f}}if(b.test(e))return{shortCircuit:!0,url:e.replace(b,u+"?")};let i=await L(o,e,s),a=U(i.url,l),m=a.test(d)&&d.replace(a,"$1")||a.test(r)&&r.replace(a,"$1");if(m?i.url=P.test(m)?m:u+"#-#"+m:r&&r!=="0"&&(i.url.startsWith("node:")||(i.url+="?esmkgdefs="+r)),O.test(t)&&!m)throw $.errModuleIdNotMocked(i.url,t.split("?")[0]);return i},K=u+"?esmock-loader=true",ce=(e=>async()=>e=e||(await import(K)).default===!0)(),X=async(e,s,o)=>{if(e===K)return{format:"module",shortCircuit:!0,responseURL:e,source:"export default true"};let n=j(e)||e,t=n&&(n.match(h)||[])[0];if(t){let[c,d]=Q(n);if(d&&d.length){let r=await o(e,s);if(!J.test(r.format))return r;let i=r.source===null||r.source===void 0,a=String(i?await G.readFile(new URL(e)):r.source),m=(a.match(M)||[])[0]||"",p=m?a.replace(M,""):a,f=r.format==="commonjs"?`const {${d}} = global.esmockCacheGet("${c}");`:`import {${d}} from '${c}';`;return{format:r.format,shortCircuit:!0,responseURL:encodeURI(e),source:m+f+p}}}if(R.test(e))return o(e,s);e=e.replace(W,""),e.startsWith(u)&&(e=e.replace(H,""),q.test(e)&&(e=e.replace(u,`file:///${e.match(B)[1]}`)));let l=k.test(e)&&e.replace(k,"$1").replace(z,"").split(",");return l&&l[0]?g[e]?{format:"json",shortCircuit:!0,responseURL:encodeURI(e),source:g[e]}:{format:"module",shortCircuit:!0,responseURL:encodeURI(e),source:l.map(c=>c==="default"?`export default global.esmockCacheGet("${e}").default`:`export const ${c} = global.esmockCacheGet("${e}").${c}`).join(`
`)}:(t&&!e.includes(t)&&(e=e+"?esmk="+t.split("=")[1]),o(e,s))},ne=S&&X;export{ce as default,ne as getSource,oe as globalPreload,te as initialize,X as load,re as resolve};
